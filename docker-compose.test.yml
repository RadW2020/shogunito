# ==============================================
# SHOGUN - Docker Compose for Testing
# ==============================================
# This file is optimized for E2E testing
# Usage: docker-compose -f docker-compose.test.yml up -d
#
# PORTS (different from dev and prod to avoid collisions):
# - PostgreSQL: 5434 (dev uses 5432, prod uses 5433)
# - MinIO: 9012/9013 (dev uses 9000/9001, prod uses 9010/9011)

services:
  # PostgreSQL database for E2E tests
  postgres-test:
    image: postgres:15-alpine
    container_name: shogun-postgres-test
    environment:
      POSTGRES_USER: shogun_test
      POSTGRES_PASSWORD: shogun_test_password
      POSTGRES_DB: shogun_test
    ports:
      - '5434:5432'  # Port 5434 to avoid collision with prod (5433) and dev (5432)
    volumes:
      - postgres-test-data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U shogun_test']
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - shogun-test-network

  # MinIO object storage for E2E tests
  minio-test:
    image: minio/minio:latest
    container_name: shogun-minio-test
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - '9012:9000'  # API - Port 9012 to avoid collision with prod (9010) and dev (9000)
      - '9013:9090'  # Console - Port 9013 to avoid collision with prod (9011) and dev (9001)
    volumes:
      - minio-test-data:/data
    command: server /data --console-address ":9090"
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:9000/minio/health/live']
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - shogun-test-network

volumes:
  postgres-test-data:
    driver: local
  minio-test-data:
    driver: local

networks:
  shogun-test-network:
    driver: bridge
